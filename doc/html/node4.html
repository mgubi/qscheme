<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!--Converted with LaTeX2HTML 99.2beta6 (1.42)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>3 How it works</TITLE>
<META NAME="description" CONTENT="3 How it works">
<META NAME="keywords" CONTENT="s">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<META NAME="Generator" CONTENT="LaTeX2HTML v99.2beta6">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="s.css">

<LINK REL="next" HREF="node5.html">
<LINK REL="previous" HREF="node3.html">
<LINK REL="up" HREF="s.html">
<LINK REL="next" HREF="node5.html">
</HEAD>

<BODY >
<!--Navigation Panel-->
<A NAME="tex2html207"
  HREF="node5.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next"
 SRC="/usr/share/latex2html/icons/next.png"></A> 
<A NAME="tex2html203"
  HREF="s.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up"
 SRC="/usr/share/latex2html/icons/up.png"></A> 
<A NAME="tex2html197"
  HREF="node3.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous"
 SRC="/usr/share/latex2html/icons/prev.png"></A> 
<A NAME="tex2html205"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents"
 SRC="/usr/share/latex2html/icons/contents.png"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html208"
  HREF="node5.html">4 Ignore this</A>
<B> Up:</B> <A NAME="tex2html204"
  HREF="s.html">QScheme Documentation</A>
<B> Previous:</B> <A NAME="tex2html198"
  HREF="node3.html">2 Introduction</A>
 &nbsp <B>  <A NAME="tex2html206"
  HREF="node1.html">Contents</A></B> 
<BR>
<BR>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsections</STRONG></A>

<UL>
<LI><A NAME="tex2html209"
  HREF="node4.html#SECTION00041000000000000000">3.1 The Read/Eval/Print Loop</A>
<UL>
<LI><A NAME="tex2html210"
  HREF="node4.html#SECTION00041100000000000000">3.1.1 The compiler</A>
<LI><A NAME="tex2html211"
  HREF="node4.html#SECTION00041200000000000000">3.1.2 The optimizer</A>
<LI><A NAME="tex2html212"
  HREF="node4.html#SECTION00041300000000000000">3.1.3 The assembler</A>
</UL>
<LI><A NAME="tex2html213"
  HREF="node4.html#SECTION00042000000000000000">3.2 Where in the source ?</A>
</UL>
<!--End of Table of Child-Links-->
<HR>

<H1><A NAME="SECTION00040000000000000000">
3 How it works</A>
</H1>

<P>
This section gives some technical informations about QScheme.

<P>

<H2><A NAME="SECTION00041000000000000000">
3.1 The Read/Eval/Print Loop</A>
</H2>

<P>
A classical Scheme interpreter works in a loop, the famous REPL, which stands
for ``Read, Eval, Print Loop''. My Scheme largely conforms to this. In order
to achieve speed and flexibility, the REPL has been slightly changed.

<P>
<BR><P></P>
<DIV ALIGN="CENTER"><A NAME="91"></A>
<TABLE>
<CAPTION><STRONG>Table 1:</STRONG>
The Read/Eval/Print Loop</CAPTION>
<TR><TD><IMG
 WIDTH="116" HEIGHT="217" BORDER="0"
 SRC="img1.png"
 ALT="\begin{table}{\par\centering\includegraphics{repl.eps}\par }
\par\end{table}"></TD></TR>
</TABLE>
</DIV><P></P>
<BR>

<P>
The simple <TT>eval</TT> procedure has been split in 4 parts, namely <TT>compile
optimize assemble execute</TT>. 

<P>
The compile phase transforms the list given by the <TT>read</TT> procedure into
an intermediate code (<I>icode</I>) representation. This code is stored
in a standard array and can be manipulated with the standard Scheme procedures.The
<I>icode</I> is describe hereafter.

<P>
The optimizer transforms the <I>icode</I> generated by the compiler, mainly
to implement tail recursion.

<P>
The assembler transforms the <I>icode</I> to a code which can be executed by
the virtual machine. The <I>vmcode</I> is an internal code. It cannot be changed
from the Scheme interpreter. It only can be printed for debugging purpose, see
the <TT>disasm</TT> function.

<P>
With this design, the compiler and the optimizer can be written in Scheme itself.

<P>

<H3><A NAME="SECTION00041100000000000000">
3.1.1 The compiler</A>
</H3>

<P>
The <I>compiler</I> takes a list as input and generates an <I>icode</I> array.
The input list is typically delivered by the <TT>read</TT> function.

<P>
When the compiler encounters a symbol which is bound to a macro, the macro code
is evaluated and the result of this evaluation replaces the original form.

<P>
After compilation, the <I>icode</I> array contains assembly instructions. See
table <A HREF="#asminstr_table">2</A>.

<P>
<BR><P></P>
<DIV ALIGN="CENTER"><A NAME="2296"></A>
<TABLE>
<CAPTION><STRONG>Table 2:</STRONG>
Assembly instructions</CAPTION>
<TR><TD>
<DIV ALIGN="CENTER"><TABLE CELLPADDING=3 BORDER="1">
<TR><TD ALIGN="LEFT">Instruction</TD>
<TD ALIGN="LEFT">Argument</TD>
<TD ALIGN="LEFT">Description</TD>
</TR>
<TR><TD ALIGN="LEFT">nop</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">no operation</TD>
</TR>
<TR><TD ALIGN="LEFT">end</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">terminate</TD>
</TR>
<TR><TD ALIGN="LEFT">dolet</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">start of a let</TD>
</TR>
<TR><TD ALIGN="LEFT">dolet*</TD>
<TD ALIGN="LEFT">nvars</TD>
<TD ALIGN="LEFT">start of a let*</TD>
</TR>
<TR><TD ALIGN="LEFT">end-letjump</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">tail optimization</TD>
</TR>
<TR><TD ALIGN="LEFT">endlet-return</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">tail optimization</TD>
</TR>
<TR><TD ALIGN="LEFT">drop</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">forget top of stack value</TD>
</TR>
<TR><TD ALIGN="LEFT">pushq</TD>
<TD ALIGN="LEFT">lit</TD>
<TD ALIGN="LEFT">push lit</TD>
</TR>
<TR><TD ALIGN="LEFT">pushv</TD>
<TD ALIGN="LEFT">sym</TD>
<TD ALIGN="LEFT">push value of symbol</TD>
</TR>
<TR><TD ALIGN="LEFT">pushl</TD>
<TD ALIGN="LEFT">var# depth</TD>
<TD ALIGN="LEFT">push local variable</TD>
</TR>
<TR><TD ALIGN="LEFT">store</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">store to symbol</TD>
</TR>
<TR><TD ALIGN="LEFT">store-evar</TD>
<TD ALIGN="LEFT">evar</TD>
<TD ALIGN="LEFT">store to extern variable</TD>
</TR>
<TR><TD ALIGN="LEFT">setl</TD>
<TD ALIGN="LEFT">varnum depth</TD>
<TD ALIGN="LEFT">set local variable</TD>
</TR>
<TR><TD ALIGN="LEFT">getvar</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">get value of a variable</TD>
</TR>
<TR><TD ALIGN="LEFT">setvar</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">set value of a variable</TD>
</TR>
<TR><TD ALIGN="LEFT">mark</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">push a partial continuation</TD>
</TR>
<TR><TD ALIGN="LEFT">mkclosure</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">pack a closure</TD>
</TR>
<TR><TD ALIGN="LEFT">mkproc</TD>
<TD ALIGN="LEFT">varlist #args #local optarg? code</TD>
<TD ALIGN="LEFT">create a procedure</TD>
</TR>
<TR><TD ALIGN="LEFT">mkcode</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">unused yet</TD>
</TR>
<TR><TD ALIGN="LEFT">endlet</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">terminate let clause</TD>
</TR>
<TR><TD ALIGN="LEFT">return</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">terminate procedure</TD>
</TR>
<TR><TD ALIGN="LEFT">callp</TD>
<TD ALIGN="LEFT">prim</TD>
<TD ALIGN="LEFT">call primitive</TD>
</TR>
<TR><TD ALIGN="LEFT">callc</TD>
<TD ALIGN="LEFT">cfunc</TD>
<TD ALIGN="LEFT">call c function</TD>
</TR>
<TR><TD ALIGN="LEFT">call</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">general call</TD>
</TR>
<TR><TD ALIGN="LEFT">jump</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">general jump</TD>
</TR>
<TR><TD ALIGN="LEFT">br-and</TD>
<TD ALIGN="LEFT">#label</TD>
<TD ALIGN="LEFT">branch for and</TD>
</TR>
<TR><TD ALIGN="LEFT">br-or</TD>
<TD ALIGN="LEFT">#label</TD>
<TD ALIGN="LEFT">branch for or</TD>
</TR>
<TR><TD ALIGN="LEFT">bra</TD>
<TD ALIGN="LEFT">#label</TD>
<TD ALIGN="LEFT">branch always</TD>
</TR>
<TR><TD ALIGN="LEFT">brf</TD>
<TD ALIGN="LEFT">#label</TD>
<TD ALIGN="LEFT">branch if false</TD>
</TR>
<TR><TD ALIGN="LEFT">brt</TD>
<TD ALIGN="LEFT">#label</TD>
<TD ALIGN="LEFT">branch if true</TD>
</TR>
<TR><TD ALIGN="LEFT">catch</TD>
<TD ALIGN="LEFT">#label</TD>
<TD ALIGN="LEFT">catch</TD>
</TR>
<TR><TD ALIGN="LEFT">uncatch</TD>
<TD ALIGN="LEFT">-</TD>
<TD ALIGN="LEFT">uncatch</TD>
</TR>
<TR><TD ALIGN="LEFT">label</TD>
<TD ALIGN="LEFT">#label</TD>
<TD ALIGN="LEFT">generate lab for branching</TD>
</TR>
</TABLE></DIV>
<P>
<DIV ALIGN="CENTER"></DIV>

<P>
</TD></TR>
</TABLE>
</DIV><P></P>
<BR>

<P>

<H3><A NAME="SECTION00041200000000000000">
3.1.2 The optimizer</A>
</H3>

<P>
The <I>optimizer</I> transforms the <I>icode</I>. The main optimizations are:

<P>

<UL>
<LI>branch to a return is changed to return. For example the sequence: <TT>... (bra
10) ... (label 10) (return)</TT> is transformed to: <TT>... (return) ... (label
10) (return).</TT>
</LI>
<LI>transforms <TT>(endlet) (return)</TT> to <TT>(endlet-return</TT>)
</LI>
<LI>transforms <TT>(call) (return)</TT> to <TT>(jump)</TT>
</LI>
<LI>transforms <TT>(call) (endlet-return)</TT> to <TT>(endlet-jump)</TT>
</LI>
</UL>
The optimization process is not really very optimized. It just iterates through
the <I>icode</I> until no further optimization can be done.

<P>

<H3><A NAME="SECTION00041300000000000000">
3.1.3 The assembler</A>
</H3>

<P>
The assembler transforms the <I>intermediate code</I> to real <I>virtual
machine code</I>. During this transformation, the ``<TT>nop</TT>'' <I>icodes</I>
generated during optimization are ignored and the labels are mapped to actual
addresses.

<P>

<H2><A NAME="SECTION00042000000000000000">
3.2 Where in the source ?</A>
</H2>

<P>
The compiler/assembler is implemented in the <TT>asm.c</TT> source file. There
you can find the complete list of opcodes.

<P>
The <TT>execute</TT> and <TT>read</TT> functions are located in the <TT>s.c</TT>
file. I'm not totally happy with this and may move these functions elsewhere.

<P>
<HR>
<!--Navigation Panel-->
<A NAME="tex2html207"
  HREF="node5.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next"
 SRC="/usr/share/latex2html/icons/next.png"></A> 
<A NAME="tex2html203"
  HREF="s.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up"
 SRC="/usr/share/latex2html/icons/up.png"></A> 
<A NAME="tex2html197"
  HREF="node3.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous"
 SRC="/usr/share/latex2html/icons/prev.png"></A> 
<A NAME="tex2html205"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents"
 SRC="/usr/share/latex2html/icons/contents.png"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html208"
  HREF="node5.html">4 Ignore this</A>
<B> Up:</B> <A NAME="tex2html204"
  HREF="s.html">QScheme Documentation</A>
<B> Previous:</B> <A NAME="tex2html198"
  HREF="node3.html">2 Introduction</A>
 &nbsp <B>  <A NAME="tex2html206"
  HREF="node1.html">Contents</A></B> 
<!--End of Navigation Panel-->
<ADDRESS>
Daniel Crettol
2000-06-12
</ADDRESS>
</BODY>
</HTML>
